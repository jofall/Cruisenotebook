---
title: |
  ![](HI logo farger engelsk){width=1in}  
  Coastal survey 2019 R/V Johan Hjort
author: 'Report generated by: Johanna Fall'
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  pdf_document:
    extra_dependencies: flafter
    toc: yes
    toc_depth: 3
    number_sections: true
---
\fontsize{12}{18}
\selectfont

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi = 300, dev = "CairoPNG")
```

```{r customise report to cruise, echo=FALSE, message=FALSE}
# Define cruise directory. If you have copied files into your R studio project directory, set mydir <- NULL (NB! If choosing this option you need to have the same folder structure in your project directory as in cruise_data)
mydir <- "//ces.imr.no/cruise_data/2019/S2019210_PJOHANHJORT_1019"

# Define depth contours
d.contours<-c(-50,-200,-400,-500) #Depth contours for plots with bathymetry

# Define the countries to show in the maps 
# (the map package uses country names from the 1980s, use: 
# regions <- map_data("worldHires")); regions[grepl("U", regions)] 
# to find country/region names starting with the letter defined in the grepl function)
regions <- c("Norway", "Sweden", "Finland", "USSR", "UK")

# Select species for distribution maps (scientific names starting with a capital letter)
species <- c("Mallotus villosus", "Boreogadus saida","Micromesistius poutassou", "Clupea harengus", 
             "Melanogrammus aeglefinus", "Gadus morhua", "Sebastes mentella", "Sebastes norvegicus", 
             "Sebastes viviparus", "Pandalus borealis")

# Set max size of bubbles in species distribution plots
Bubble.size<-8      

# Select metric for catches in species distribution plots (one or both)
numplot <- 0 #catches in numbers/nmi
bioplot <- 1 #catches in kg/nmi
```

```{r setup space between plots, echo=FALSE, message=FALSE}
my_plot_hook <- function(x, options)
  paste("\n", knitr::hook_plot_tex(x, options), "\n")
knitr::knit_hooks$set(plot = my_plot_hook)
```

```{r install and load packages, echo=FALSE, message=FALSE}
#Load required packages
Packages <- c("data.table", "reshape2", "readxl", "readODS", "worms","Cairo",
              "bookdown", "RstoxData", "maps", "mapdata", "chron","tidyverse", "ggforce", "kableExtra", "stringr")

invisible(lapply(Packages, FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
))
```

```{r directory check, echo=FALSE, message=FALSE}
# Directory check - controls which parts of the script that will be run
ACO <- ifelse(is.null(mydir),dir.exists("ACOUSTIC/LSSS/REPORTS"), dir.exists(paste0(mydir,"/ACOUSTIC/LSSS/REPORTS")))
BIO <- ifelse(is.null(mydir), dir.exists("BIOLOGY/CATCH_MEASUREMENTS/BIOTIC"), dir.exists(paste0(mydir,"/BIOLOGY/CATCH_MEASUREMENTS/BIOTIC")))
CTD <- ifelse(is.null(mydir), dir.exists("PHYSICS/CTD/CTD_DATA"), dir.exists(paste0(mydir,"/PHYSICS/CTD/CTD_DATA")))
TRA <- ifelse(is.null(mydir), dir.exists("CRUISE_LOG/TRACK"), dir.exists(paste0(mydir,"/CRUISE_LOG/TRACK")))
```

\pagebreak

# Survey description and data availability

\pagebreak

# Cruise tracks and stations

Cruise tracks from the position log with points indicating start positions for different sampling gear. Points are jittered.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height=6, out.width= "80%", fig.align="center", eval = TRA}

#create a list of the position files from the target directory
file_list <- if(is.null(mydir)){
  list.files(path = "CRUISE_LOG/TRACK",pattern = ".csv")} else
    list.files(path=paste0(mydir,"/CRUISE_LOG/TRACK"),pattern = ".csv")

#initiate a blank data frame, each iteration of the loop will append the data from the given file to this variable
dataset <- data.frame()

#set temporary working directory
invisible(ifelse(is.null(mydir),setwd("CRUISE_LOG/TRACK"),
       setwd(paste0(mydir,"/CRUISE_LOG/TRACK"))))

for (i in 1:length(file_list)){
  temp_data <- data.table::fread(file_list[i], stringsAsFactors = F,header = T, skip = 2,fill = T,strip.white = FALSE) #read in files using the fread function from the data.table package
  #creating a new column that indicates which date each file comes from
  temp_data$Date <- strsplit(gsub(".csv", "", file_list[i]), "s")[[1]][2]
  temp_data$Date <- as.Date(temp_data$Date, format = "%d-%m-%Y")
  #The latitude column is in format "DDMM.MMMM N"
  #The longitude column is in format "0DDMM.MMMM E"
  #Create new columns with lon and lat in decimal degrees
  temp_data <- temp_data %>% tidyr::separate(Latitude, into = c("DD", "MM", "x1"),
                                      sep = c(2,9), remove = F) %>%
    tidyr::separate(Longitude, into = c("x1.lon", "DD.lon", "MM.lon", "x2.lon"),
             sep = c(1,3,10), remove = F)
  temp_data$EW <- substr(temp_data$Longitude, nchar(temp_data$Longitude) - 1 + 1,
                         nchar(temp_data$Longitude)) 
  temp_data$DD <- as.numeric(temp_data$DD)
  temp_data$DD.lon <- as.numeric(temp_data$DD.lon)
  temp_data$MM <- as.numeric(temp_data$MM)
  temp_data$MM.lon <- as.numeric(temp_data$MM.lon)
  temp_data$Lat.dd <- temp_data$DD + temp_data$MM/60
  temp_data$Lon.dd <- temp_data$DD.lon + temp_data$MM.lon/60
  
  #modify Longitude according to E/W
  temp_data$EWF<-c(1)
  setDT(temp_data)[EW=="W", EWF:=-1]
  
  temp_data$Lon.dd <- (temp_data$DD.lon + temp_data$MM.lon/60)*temp_data$EWF

  temp_data <-  temp_data %>% dplyr::rename(gear.text = `Station type`)
  
  #for each iteration, bind the new data to the building dataset
  dataset <- rbindlist(list(dataset, temp_data), use.names = T, fill = T) 
  #arrange after date
  dataset  <- dataset %>% arrange(Date)
  rm(temp_data)
  }

#Define plotting symbols
dataset$symbol[grepl("^Pelagic",dataset$gear.text)] <- 2
dataset$symbol[grepl("^Bottom",dataset$gear.text)] <- 0
dataset$symbol[grepl("^Bom",dataset$gear.text)] <- 0
dataset$symbol[grepl("^CTD",dataset$gear.text)] <- 13
dataset$symbol[grepl("^HÃ¥v",dataset$gear.text)] <- 1
dataset$symbol[grepl("^Mik",dataset$gear.text)] <- 1
dataset$symbol[grepl("^Multinet",dataset$gear.text)] <- 5
dataset$symbol[grepl("^Garn",dataset$gear.text)] <- 12
dataset$symbol[grepl("^Snurrevad",dataset$gear.text)] <- 8
dataset$symbol[grepl("^Not",dataset$gear.text)] <- 9
dataset$symbol[grepl("^Other",dataset$gear.text)] <- 3

sym <- c(dataset %>% select(gear.text, symbol) %>% unique() %>% select(symbol))
val <- c(dataset %>% select(gear.text, symbol) %>% unique() %>% select(gear.text))

#Get mapdata
europe <- map_data("worldHires", region = regions) 

# Define limits of map
Xlim <- c(min(dataset$Lon.dd, na.rm = T)-0.5, max(dataset$Lon.dd, na.rm = T)+0.5)
Ylim <- c(min(dataset$Lat.dd, na.rm = T)-0.5, max(dataset$Lat.dd, na.rm = T)+0.5)

#Plot the cruise tracks and stations
set.seed(1) #set seed for fixed jittering of points
ggplot()+ 
  geom_map(data=europe, map=europe,  aes(x=long, y=lat, map_id=region),
           color="gray60", fill="lightyellow2", size = 0.25)+
  geom_point(data=dataset, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1,
             colour="grey65", size=0.005, inherit.aes = F)+
  geom_point(data = dataset %>% dplyr::filter(!gear.text == "  -->" &
                                                !grepl("stop",gear.text)), 
             aes(Lon.dd, Lat.dd,shape = gear.text), size = 2, stroke = 0.25,
             inherit.aes = F, position = ggforce::position_jitternormal(sd_y = 0.08, sd_x = 0.35))+
  scale_shape_manual(breaks = val$gear.text, values = as.numeric(sym$symbol))+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = "Longitude", y = "Latitude", shape="Sampling gear")
```

\pagebreak

```{r, echo = FALSE, eval = CTD}
cat("# CTD\n")
```

```{r, echo=FALSE, message=FALSE, eval = CTD}

#create a list of the files from your target directory
file_list <- if(is.null(mydir)){
  list.files(path = "PHYSICS/CTD/CTD_DATA",pattern = ".cnv")} else
    list.files(path=paste0(mydir,"/PHYSICS/CTD/CTD_DATA"),pattern = ".cnv")

#set temporary working directory
invisible(ifelse(is.null(mydir),setwd("PHYSICS/CTD/CTD_DATA"),
       setwd(paste0(mydir,"/PHYSICS/CTD/CTD_DATA"))))

#initiate a blank data frame, each iteration of the loop will append the data from the given file to this variable
ctd <- data.frame()

for (i in 1:length(file_list)){
  if(i == 1){
    # Read the file by lines
    DT <- readLines(file_list[i]) 
    # Detect lines containing variable names
    name_lines <- str_detect(DT, "# name")
    # Keep those lines 
    DT <- DT[name_lines]
    # Grep the variable names
    DT <- str_extract(DT, "(?<== ).+(?=\\:)")
  }
  #read in files using the fread function from the data.table package
  #NB!only variables present in the first data file will be kept
  temp_data <- fread(file_list[i], stringsAsFactors = F,header = F, skip = "*END*") 
  if(ncol(temp_data) == length(DT)){names(temp_data) <- DT} else{
    # Read the file by lines
    DTi <- readLines(file_list[i]) 
    # Detect lines containing variable names
    name_lines <- str_detect(DTi, "# name")
    # Keep those lines 
    DTi <- DTi[name_lines]
    # Grep the variable names
    DTi <- str_extract(DTi, "(?<== ).+(?=\\:)")
    names(temp_data) <- DTi
    temp_data <- temp_data[,..DT]
  }
    #select the measurements from when the CTD was descending
    temp_data <- temp_data[1:ceiling(nrow(temp_data)/2),]
    #Create a station variable from the file name
    station <- strsplit(gsub(".cnv", "", file_list[i]), "sort")[[1]][1] 
    temp_data$station <- strsplit(gsub("[^[:digit:]]", "", station), "sort")[[1]][1] 
    #for each iteration, bind the new data to the building dataset
    ctd <- rbindlist(list(ctd, temp_data), use.names = T) 
    #remove the temp file
    rm(temp_data)
}

##position of stations is in data.frame called dataset from the cruise log
#Combine with CTD data
ctdpos <- dataset %>% 
  dplyr::select(4,Time,Date, Lon.dd, Lat.dd, gear.text) %>% 
  dplyr::rename(station = 1) %>% dplyr::filter(!is.na(station) & gear.text %in% dataset$gear.text[grepl("^CTD",dataset$gear.text)]) %>% 
  dplyr::arrange(station) %>% data.frame()

if(nrow(ctdpos)>0){
  ctdpos$station <- as.character(ctdpos$station) 

ctdpos <- ctdpos %>% dplyr::group_by(station) %>% 
  dplyr::summarise(Lon = mean(Lon.dd),Lat = mean(Lat.dd), Time = unique(Time)[1], 
                   Date = unique(Date)[1])
ctdpos$station <- paste0("0",ctdpos$station)
ctd <- left_join(ctd, ctdpos)

maxdepth <- ctd %>% dplyr::group_by(station, Lon, Lat) %>% 
  dplyr::summarise(max_depth = max(prDM))
ctd <- left_join(ctd, maxdepth)
ctd$plotdepth <- NA
ctd$plotdepth[ctd$prDM<=50] <- "Surface"
ctd$plotdepth[ctd$max_depth-ctd$prDM<=50] <- "Bottom"

#If the depth is <= 50 m, the surface layer will be overwritten by the bottom layer in the command above. Therefore add an extra line with the same temperature for surface.
for(i in 1:nrow(ctdpos)){
  if(ctd$max_depth[i]<=51){
    extra <- ctd[i,]
    extra$plotdepth <- "Surface"
    ctd <- rbind(ctd, extra)
  }}

ctd.plot <- ctd %>% dplyr::group_by(station, Lon, Lat, Date, Time, plotdepth, max_depth) %>% 
  dplyr::summarise(mean_temp = mean(t068C), mean_salinity = mean(sal00)) %>% dplyr::filter(!is.na(plotdepth)) %>% 
  data.frame()
}

ctdpos <- nrow(ctdpos)>0
```

```{r, echo = FALSE, eval = CTD}
cat("## Summary of measurements\n")
```

```{r, eval = CTD, echo = FALSE, message = FALSE}
cat("\nNumber of CTD casts done during the cruise:")
```

`r if(CTD==TRUE) length(unique(ctd$station))`

```{r, eval = CTD, echo = FALSE, message = FALSE}
cat("\nTotal depth covered by CTDs (km):")
```

`r if(CTD==TRUE) round(sum(maxdepth$max_depth)/1000, digits = 1)`

```{r, echo=FALSE, fig.height=3, fig.width=4.5, out.width= "40%",fig.show="hold", message=FALSE, warning=FALSE, eval = CTD}

ggplot(ctd, aes(t068C))+geom_histogram(color="black")+theme_bw()+
  labs(x = "Temperature (deg C)", y = "Count")

ggplot(ctd, aes(sal00))+geom_histogram(color="black")+theme_bw()+
  labs(x = "Salinity (PSU)", y = "Count")
```

\pagebreak

```{r, echo = FALSE, eval = ifelse(ctdpos == FALSE, ctdpos, CTD)}
cat("## Variation in temperature and salinity with bathymetry and geographical location\n")
```

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=4, out.width= "100%", warning=FALSE, fig.align="center", eval = ifelse(ctdpos == FALSE, ctdpos, CTD)}

#Get coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

ggplot()+ 
  geom_map(data=europe, map=europe,  aes(x=long, y=lat, map_id=region),
           color="gray60", fill="lightyellow2", size = 0.25)+
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey45", size=0.1, inherit.aes = F)+
  geom_point(data=ctd.plot, aes(Lon, Lat, fill = mean_temp), size = 2, color="black", shape = 21)+
  facet_wrap(~plotdepth)+
  scale_fill_distiller(palette="RdYlBu")+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = "Longitude", y = "Latitude", fill="Mean temperature
(deg C)")
```

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=4, out.width= "100%", warning=FALSE, fig.align="center", eval = ifelse(ctdpos == FALSE, ctdpos, CTD)}

ggplot()+
  geom_map(data=europe, map=europe,  aes(x=long, y=lat, map_id=region),
           color="gray60", fill="lightyellow2", size = 0.25)+
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey45", size=0.1, inherit.aes = F)+
  geom_point(data=ctd.plot, aes(Lon, Lat, fill = mean_salinity), size = 2, color="black", shape = 21)+
  facet_wrap(~plotdepth)+
  scale_fill_distiller(palette="BuPu", trans = "reverse", guide = guide_colorbar(reverse = T))+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = "Longitude", y = "Latitude", fill="Mean salinity (PSU)")
```

\pagebreak

```{r, echo = FALSE, eval = CTD}
cat("## Density in the water column\n")
```

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=2.8, warning=FALSE, fig.align="center", eval = CTD}

depthlim <- 100 #choose the maximum depth you want to plot

ggplot(ctd, aes(`sigma-t00`, prDM, group=station, color=ifelse(is.null(ctd$Lat),as.numeric(station),Lat)))+
  geom_line(size = 0.55, show.legend = ifelse(is.null(ctd$Lat), FALSE, TRUE))+
  scale_y_reverse(limits=c(depthlim,0))+
  scale_color_distiller(palette="Spectral")+
  labs(x = expression("Density (sigma-t, kg/"*m^3*")"), 
       y = "Depth (m)", color=ifelse(is.null(ctd$Lat),"Station", "Latitude (N)"))+
  theme_bw()+
  theme(panel.background = element_rect(fill="black"),panel.grid.major = element_line(color = "grey45", size = 0.1, linetype=1),
                   panel.grid.minor = element_blank())

ggplot(ctd, aes(`sigma-t00`, prDM, group=station, color=Lon))+
  geom_line(size = 0.55)+
  scale_y_reverse(limits=c(depthlim,0))+
  scale_color_distiller(palette="Spectral")+
  # scale_color_viridis_c(option = "A")+
  labs(x = expression("Density (sigma-t, kg/"*m^3*")"), 
       y = "Depth (m)", color="Longitude (E)")+
  theme_bw()+theme(panel.background = element_rect(fill="black"),
                   panel.grid.major = element_line(color = "grey45", size = 0.1, linetype=1),
                   panel.grid.minor = element_blank())
```

\pagebreak

```{r, echo = FALSE, eval = CTD}
cat("## Light in the water column\n")
```

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=4, warning=FALSE, fig.align="center", eval = CTD}

tst <- strptime(ctd$Time, format = "%H:%M:%S")
tt1 <- chron::times(format(tst, "%H:%M:%S"))
ctd$timetest <- tt1

ctd$newtime <- hours(ctd$timetest)

ggplot(ctd, aes(par, prDM, group=station, color=newtime))+
  geom_line(size = 0.55)+
  scale_y_reverse(limits=c(depthlim,0))+
  scale_color_distiller(palette="Spectral")+
  # scale_color_viridis_c(option = "A")+
  labs(x = expression("PAR irradiance ("*mu*"E/"*m^2*"s"*")"), 
       y = "Depth (m)", color="Time of day (h)")+
  theme_bw()+theme(panel.background = element_rect(fill="black"),
        panel.grid.major = element_line(color = "grey45", size = 0.1, linetype=1),
        panel.grid.minor = element_blank())

```

\pagebreak

```{r read in biotic data, echo = FALSE, message=FALSE, warning = FALSE, results='hide', eval=BIO}
#specify file path
tokt <- if(is.null(mydir) == TRUE){
  paste0("BIOLOGY/CATCH_MEASUREMENTS/BIOTIC/", list.files(path = "BIOLOGY/CATCH_MEASUREMENTS/BIOTIC",pattern = ".xml"))} else{
    paste0(mydir, "/BIOLOGY/CATCH_MEASUREMENTS/BIOTIC/", list.files(path=paste0(mydir,"/BIOLOGY/CATCH_MEASUREMENTS/BIOTIC"),pattern = ".xml"))
  }

#In case of more than one xml file, choose the official biotic one containing a dash followed by the survey year (this relies on unofficial files not using this naming, needs to be tested out)
if(length(tokt)>1) tokt <- 
  tokt[grepl(paste0("-",format(dataset$Date, "%Y"))[1], tokt)]

#read in with function ReadBiotic from RstoxData
dd<- ReadBiotic(tokt)

#Combine station and catch data
if("catchweight" %in% names(dd[[1]]$catchsample)){
  stasamp <- right_join(dd[[1]]$fishstation,dd[[1]]$catchsample) %>% mutate(cr.kg.nm=catchweight/distance) %>% mutate(cr.n.nm=catchcount/distance)
} else if("weight" %in% names(dd[[1]]$catchsample)){
  stasamp <- right_join(dd[[1]]$fishstation,dd[[1]]$catchsample) %>% mutate(cr.kg.nm=weight/distance) %>% mutate(cr.n.nm=count/distance)
}

# Add scientific species names (code from Ibrahim Umar)

# Source Edvin Fugleback's script for translating species names from aphia codes
source("https://github.com/Sea2Data/cruisetools/raw/master/taxaAnnotation/annotateTaxa.R")

# Get taxa taxaTable
## Get list of aphias
aphias <- unlist(unique(stasamp$aphia[!is.na(stasamp$aphia)])) 
## Make taxa table 
taxaTable <- makeTaxaTable(aphias)

# Merge with NMD biotic data - removing scientificname column in stasamp data (NA values)
stasamp <- left_join(stasamp[,-"scientificname"], 
                     taxaTable %>% select(AphiaID,scientificname),
                     by=c("aphia"="AphiaID"))

#Legg til geartype i tekstformat
stasamp$gear.text <- NA
stasamp$gear.text[grepl("^30",stasamp$gear)] <- "Bottom trawl"
stasamp$gear.text[grepl("^31",stasamp$gear)] <- "Bottom trawl"
stasamp$gear.text[grepl("^32",stasamp$gear)] <- "Bottom trawl"
stasamp$gear.text[grepl("^34",stasamp$gear)] <- "Unspecified trawl"
stasamp$gear.text[grepl("^34",stasamp$gear)] <- "Unspecified trawl"
stasamp$gear.text[grepl("^35",stasamp$gear)] <- "Pelagic trawl"
stasamp$gear.text[grepl("^36",stasamp$gear)] <- "Danish seine"
stasamp$gear.text[grepl("^37",stasamp$gear)] <- "Seine"
stasamp$gear.text[grepl("^40",stasamp$gear)] <- "Gill net"
stasamp$gear.text[grepl("^41",stasamp$gear)] <- "Gill net"

# Station data
stdat <- stasamp %>% select(starts_with("serial"), station, ends_with("time"),
                            longitudestart,latitudestart, bottomdepthstart,
                            bottomdepthstop,fishingdepthmin, fishingdepthmax,
                            gear.text, contains("quality")) %>% unique()
stdat <- stdat[,-"dataquality"]

# Additional plotting criteria in case no gear has been registrered - then cannot
#plot gear-based figures
regcatch <- ifelse(length(stasamp$gear.text[!is.na(stasamp$gear.text)])>0, TRUE, FALSE)
```

```{r sample statistics, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("# Biotic data\n")

cat("## Sampling effort\n")

cat("Total number of hauls taken during the survey:")
```
`r if(BIO==TRUE) nrow(stdat)`

```{r sample statistics2, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("\nNumber of samples by gear type:")
knitr::kable(table(stdat$gear.text),col.names = c("Gear", "N")) %>% kable_styling(font_size = 11,position = "left")
```
  
```{r sample statistics3, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("\nRange of bottom depths at sampling stations (m, will be NA if any station is missing bottom depth):")
```
`r if(BIO==TRUE) round(range((stasamp$bottomdepthstart+stasamp$bottomdepthstop)/2), digits =1)`

```{r trawl statistics4, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("\nFishing depth range (m, will be NA if any station is missing fishing depth)):")
```
`r if(BIO==TRUE) round(range((stasamp$fishingdepthmin+stasamp$fishingdepthmax)/2), digits=1)`

```{r fig bottom depth, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("### Mean bottom depth during hauls  ")
```

```{r, echo=FALSE, message=FALSE, fig.width=8, fig.height=3, out.width= "75%", eval = ifelse(regcatch == FALSE, regcatch,BIO)}
#Bottom depth
ggplot(stdat, aes((bottomdepthstart+bottomdepthstop)/2))+
  geom_histogram(color="black", position = "dodge")+
  labs(x= "Mean bottom depth during haul (m)", y = "Number")+
  facet_wrap(~gear.text)+theme_bw()+
  scale_y_continuous(breaks = c(0,2,4,6,8,10,12))
```

```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("### Mean fishing depth during hauls\n")
```

```{r, echo=FALSE, message=FALSE, fig.width=6, fig.height=3, out.width= "50%", eval=ifelse(regcatch == FALSE, regcatch,BIO)}
#Fishing depth
ggplot(stdat, aes((fishingdepthmin+fishingdepthmax)/2, fill = gear.text))+
  geom_histogram(color="black")+
  labs(x= "Mean fishing depth during haul (m)", y = "Number")+
  scale_fill_viridis_d(name = "Gear")+theme_bw()
```
\pagebreak

```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("## Catch composition\n")

cat("### Species diversity\n")
```

```{r,echo=FALSE, message=FALSE, eval=ifelse(regcatch == FALSE, regcatch,BIO)}
#Sjekk hvilke arter som er vanligst
options(dplyr.summarise.inform=F)
tst<-stasamp %>% dplyr::group_by(scientificname) %>% 
  dplyr::summarise(meanW=mean(cr.kg.nm), meanN = mean(cr.n.nm),
                   minW = min(cr.kg.nm), maxW = max(cr.kg.nm),
                   minN = min(cr.n.nm), maxN = max(cr.n.nm))
```

```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("Number of species registered during the survey:")
```
`r if(regcatch==TRUE) length(unique(tst$scientificname))`

```{r, echo = FALSE, message=FALSE, fig.width=6, fig.height=4, out.width= "50%", eval = ifelse(regcatch == FALSE, regcatch,BIO)}
#cumulative number of species vs number of stations
nspec <- data.frame(station=unique(stasamp$station[!is.na(stasamp$station)]),
           nspecies=tapply(cumsum(!duplicated(stasamp$scientificname[!is.na(stasamp$station)])), stasamp$station[!is.na(stasamp$station)],max))

nspec$nstation <- seq(1:nrow(nspec))

ggplot(nspec, aes(nstation, nspecies))+geom_line(size = 1)+theme_bw()+
  labs(x = "Number of stations sampled", y = "Number of unique species identified",
       title = "Number of species identified versus number of stations sampled
(excluding samples without station number)")
```

```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("### Maximum catch rates by gear and species\n")
```

```{r,echo=FALSE, message=FALSE, warning=FALSE, eval= ifelse(regcatch == FALSE, regcatch,BIO)}
options(dplyr.summarise.inform=F)
tst<-subset(stasamp, gearcondition==1) %>% 
  dplyr::group_by(gear.text,scientificname) %>% 
  dplyr::summarise(meanW=mean(cr.kg.nm), meanN = mean(cr.n.nm),
                   minW = min(cr.kg.nm), maxW = max(cr.kg.nm),
                   minN = min(cr.n.nm), maxN = max(cr.n.nm))
```

```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis', fig.align="left"}
cat("Species with highest catch rate by biomass:")

kableExtra::kable(tst %>% group_by(gear.text) %>% slice_max(maxW) %>% select(gear.text, scientificname) %>% data.frame(),col.names = c("Gear", "Scientific name")) %>% column_spec(2, italic = TRUE) %>% kable_styling(font_size = 11,position = "left")
```
  
  
```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("\nSpecies with highest catch rate by number:")

kableExtra::kable(tst %>% group_by(gear.text) %>% slice_max(maxN) %>% select(gear.text, scientificname) %>% data.frame(), col.names = c("Gear", "Scientific name")) %>% column_spec(2, italic = TRUE) %>% kable_styling(font_size = 11,position = "left")
```
\pagebreak

```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("The figures below show maximum catch rates of the 20 species with the highest maximum catch rates.")
```

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3.5, out.width= "85%", fig.align="center", warning=FALSE, eval=ifelse(regcatch == FALSE, regcatch,BIO)}
#Weight
for(i in unique(tst$gear.text)){
 g <- ggplot(tst %>% dplyr::filter(gear.text == i & !is.na(scientificname)),
       aes(reorder(scientificname, -maxW), maxW))+
    geom_col()+
    coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
    theme_bw()+
    theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11),
        axis.title.x = element_blank())+
    labs(x = "Taxon", y = "Max catch rate (kg/nmi)", title = paste0("Biomass - ", i))
 print(g)
}

#Number
for(i in unique(tst$gear.text)){
  g <- ggplot(tst %>% dplyr::filter(gear.text == i & !is.na(scientificname)),
       aes(reorder(scientificname, -maxN), maxN))+
    geom_col()+
    coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
    theme_bw()+
    theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11),
          axis.title.x = element_blank())+
    labs(x = "Taxon", y = "Max catch rate (N/nmi)", title = paste0("Number of individuals - ", i))
  print(g)
}
```

```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("## Spatial variation in catches of common species\n")
```

```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("Catches are split by gear. Bubble size is comparable between gears within the same species, but not between species. Samples taken with unspecified gear are removed.")
```

```{r spatial distribution of catches, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 11, fig.height = 5, out.width="100%", fig.align="left", eval = ifelse(regcatch == FALSE, regcatch,BIO)}

dat <- stasamp[!is.na(stasamp$gear.text),]

#Font size for gear type
tz <- 12

#Species check - remove selected species if not in data
spec.check <- dat %>% dplyr::select(scientificname) %>% unique() 
species <- species[species %in% spec.check$scientificname]

for(i in 1:length(species)) {
  if (numplot == 1) {
    Title = paste("Catch rate (number of individuals)", "|", toString(format(Sys.Date(), "%Y")),
                  "|", toString(species[i]))
    g <- ggplot() +
      geom_map(
        data = europe,
        map = europe,
        aes(x = long, y = lat, map_id = region),
        color = "gray60",
        fill = "lightyellow2",
        size = 0.25
      ) +
      geom_point(
        data = coord.track,
        aes(Lon.dd, Lat.dd, group = Date),
        alpha = 0.1,
        colour = "grey65",
        size = 0.005,
        inherit.aes = F
      ) +
      geom_point(
        data = dat %>% dplyr::filter(scientificname==species[i]),
        aes(longitudestart, latitudestart, size = cr.n.nm),
        shape = 21,
        alpha = 0.7,
        colour = "black",
        fill = "orange",
        stroke = .2
      ) +
      facet_grid( ~ gear.text) +
      scale_size_area(max_size = Bubble.size) +
      theme_bw() + theme(strip.text = element_text(size = tz))+
      coord_map(xlim = Xlim, ylim = Ylim) +
      labs(
        x = NULL,
        y = NULL,
        size = "Catch rate (N/nmi)",
        title = Title
      )
    print(g)
    
  }
  if (bioplot == 1) {
    Title = paste("Catch rate (biomass)", "|", toString(format(Sys.Date(), "%Y")),
                  "|", toString(species[i]))
    #Catch rate kg/nmi
    h <- ggplot() +
      geom_map(
        data = europe,
        map = europe,
        aes(x = long, y = lat, map_id = region),
        color = "gray60",
        fill = "lightyellow2",
        size = 0.25
      ) +
      geom_point(
        data = coord.track,
        aes(Lon.dd, Lat.dd, group = Date),
        alpha = 0.1,
        colour = "grey65",
        size = 0.005,
        inherit.aes = F
      ) +
      geom_point(
        data = dat %>% dplyr::filter(scientificname == species[i]),
        aes(longitudestart, latitudestart, size = cr.kg.nm),
        shape = 21,
        alpha = 0.7,
        colour = "black",
        fill = "orange",
        stroke = .2
      ) +
      facet_grid( ~ gear.text) +
      scale_size_area(max_size = Bubble.size) +
      theme_bw() + theme(strip.text = element_text(size = tz))+
      coord_map(xlim = Xlim, ylim = Ylim) +
      labs(
        x = NULL,
        y = NULL,
        size = "Catch rate (kg/nmi)",
        title = Title
      )
    print(h)
  }
}
```

```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("## Length-weight relationships\n")
```

```{r, echo=FALSE, message=FALSE, fig.width=11, fig.height=8, out.width= "100%", warning=FALSE, eval = ifelse(regcatch == FALSE, regcatch,BIO)}
stasampindi <- right_join(stasamp,dd[[1]]$individual)
stasampindiage <- left_join(stasampindi, dd[[1]]$agedetermination)

#m -> cm
stasampindiage$length.cm <- (stasampindiage$length * 100 )

#create list of unique species
if("individualweight" %in% names(stasampindiage)){
  species2 <- stasampindiage %>% dplyr::filter(individualweight > 0 & !is.na(scientificname)) %>% dplyr::select(scientificname) %>% unique() %>% 
  arrange(scientificname) %>% data.frame()
} else{
    species2 <- stasampindiage %>% 
      dplyr::filter(weight > 0 & !is.na(scientificname)) %>%
      dplyr::select(scientificname) %>% unique() %>% 
      arrange(scientificname) %>% data.frame()
}

# split the species into 2 or 3 plots depending on the number of unique species
# that has individual weights

if(nrow(species2) > 0 & nrow(species2) <= 50){
  
  g <- ggplot(stasampindiage %>% filter(individualweight>0 & scientificname %in% species2$scientificname[1:floor((nrow(species2)/2))] & !is.na(scientificname)),
         aes(x=length.cm, y=individualweight, group=scientificname)) +
    geom_point(size=3, shape="+") +
    facet_wrap(~scientificname, scales="free") + 
    labs(x="Length (cm)", y="Weight (kg)")+ theme_bw()
  print(g)
  
  g <- ggplot(stasampindiage %>% filter(individualweight>0 & scientificname %in% species2$scientificname[(floor((nrow(species2)/2))+1):nrow(species2)] & !is.na(scientificname)), 
         aes(x=length.cm, y=individualweight, group=scientificname)) +
    geom_point(size=3, shape="+") +
    facet_wrap(~scientificname, scales="free") + 
    labs(x="Length (cm)", y="Weight (kg)")+ theme_bw()
  print(g)
  
} else if(nrow(species2) > 0 & nrow(species2) > 50){
  g <- ggplot(stasampindiage %>% filter(individualweight>0 & scientificname %in% species2$scientificname[1:floor((nrow(species2)/3))] & !is.na(scientificname)),
         aes(x=length.cm, y=individualweight, group=scientificname))+
    geom_point(size=3, shape="+") +
    facet_wrap(~scientificname, scales="free") + 
    labs(x="Length (cm)", y="Weight (kg)")+ theme_bw()
  print(g)
  
  g <-ggplot(stasampindiage %>% filter(individualweight>0 & scientificname %in% species2$scientificname[(floor((nrow(species2)/3))+1):(floor((nrow(species2)/3)*2))] & !is.na(scientificname)),
         aes(x=length.cm, y=individualweight, group=scientificname))+
    geom_point(size=3, shape="+") +
    facet_wrap(~scientificname, scales="free") + 
    labs(x="Length (cm)", y="Weight (kg)")+ theme_bw()
  print(g)
  
  g <-ggplot(stasampindiage %>% filter(individualweight>0 & scientificname %in% species2$scientificname[(floor((nrow(species2)/3)*2)+1):nrow(species2)] & !is.na(scientificname)), 
       aes(x=length.cm, y=individualweight, group=scientificname)) +
  geom_point(size=3, shape="+")+
  facet_wrap(~scientificname, scales="free") + 
  labs(x="Length (cm)", y="Weight (kg)")+ theme_bw()
  print(g)
}
```

```{r, eval = ifelse(regcatch == FALSE, regcatch,BIO), echo = FALSE, message = FALSE, results = 'asis'}
cat("## Length-age relationships\n")
```

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=6, out.width= "80%", warning=FALSE, eval=ifelse(regcatch == FALSE, regcatch,BIO)}
if(nrow(species2) > 0){
  ggplot(stasampindiage %>% filter(age>0 & !is.na(scientificname)), 
         aes(length.cm,age))+geom_point(size = 0.5)+
    facet_wrap(~scientificname, scales = "free")+
    theme_bw()+labs(x = "Length (cm)", y = "Age (years)")
}
```





